<%inherit file="/base.html"/>

<%block name="content">

<!-- 初始化 -->

    <div class="home-page" id="app">
        <div class="cw-search-box">
            <i-form :model="searchInfo" label-position="right" :label-width="80" class="flex">


          </i-form>
            <i-button type="primary" class="btn" @click="creatEexam=true">新增</i-button>
            <i-button type="primary" class="btn" @click="search">查询</i-button>
        </div>

        <i-table :columns="columns" :data="data"></i-table>

        <Drawer title="创建考试"
            v-model="creatEexam"
            :closable="false"
            :mask-closable="false"
            width="800">
            <div style="padding: 0 15px">
                <i-form
                    :model="formItem"
                    ref="formItem"
                    :rules="ruleValidate"
                    :label-width="100">

                <form-item label="关联业务:">
                        <i-select v-model="formItem.business" clearable>
                            <i-option :value="item.label" v-for="(item,index) in business" :key="index">{{item.label}}</i-option>
                        </i-select>
                </form-item>

                 <Form-item label="考试名称：" prop="name">
                    <i-input v-model="formItem.name" placeholder="请输入..."></i-input>
                </Form-item>

                <form-item label="考试类型:">
                        <i-select v-model="formItem.exam_type" clearable>
                            <i-option :value="item.value" v-for="(item,index) in exam_type" :key="index">{{item.label}}</i-option>
                        </i-select>
                </form-item>

                <Form-item label="考试负责人：" prop="principal">
                    <i-select v-model="formItem.principal" clearable>
                        <i-option v-for="item in principal" :value="item.bk_username" :key="item.bk_username">{{ item.bk_username }}</i-option>
                    </i-select>
                </Form-item>

                <Form-item label="考试负责人联系电话：" prop="phone">
                    <i-input v-model="formItem.phone" placeholder="请输入..."></i-input>
                </Form-item>

                <form-item label="考试日期">
                    <Date-Picker type="date" v-model="formItem.exam_date"  placeholder="Select date" style="width: 300px" format="yyyy-MM-dd"></DatePicker>
                </form-item>


                <Form-item label="考试地点：" prop="site">
                    <i-input v-model="formItem.site" ></i-input>
                </Form-item>

                    <Form-item label="考试题目："  prop="topic">
                        <template>
                            <Upload action="/data_preparation/exam_upload"
                                    :on-error="handleError"
                                    :on-success="handleSuccess">
                                <i-button type="ghost" icon="ios-cloud-upload-outline">上传文件</i-button>
                            </Upload>
                        </template>
                    </Form-item>

                    <Form-item>
                        <div class="cw-btn-group">
                            <!-- 按钮启用/禁用控制（:disabled） -->
                            <i-button type="primary" @click="handleCreate" style="margin-right: 15px" >确定</i-button>
                            <i-button type="normal" @click="cancel">取消</i-button>
                        </div>
                    </Form-item>
                </i-form>
            </div>
        </Drawer>


        <Drawer title="考试详情"
            v-model="detailsData"
            :closable="false"
            :mask-closable="false"
            width="800">
            <div style="padding: 0 15px">
                <i-form
                    :model="details"
                    ref="details"
                    :label-width="100">

                    <Form-item label="考试名称：" prop="name">
                        <i-input v-model="details.name"  :disabled="true"></i-input>
                    </Form-item>

                    <Form-item label="类型：" prop="exam_type">
                        <i-input v-model="details.exam_type"  :disabled="true"></i-input>
                    </Form-item>

                    <Form-item label="关联业务：" prop="business">
                        <i-input v-model="details.business"  :disabled="true"></i-input>
                    </Form-item>

                    <Form-item label="地点：" prop="site">
                        <i-input v-model="details.site"  :disabled="true"></i-input>
                    </Form-item>

                    <Form-item label="时间：" prop="exam_date">
                        <i-input v-model="details.exam_date"  :disabled="true"></i-input>
                    </Form-item>

                    <Form-item label="负责人：" prop="principal">
                        <i-input v-model="details.principal"  :disabled="true"></i-input>
                    </Form-item>

                    <Form-item label="联系方式：" prop="phone">
                        <i-input v-model="details.phone"  :disabled="true"></i-input>
                    </Form-item>

                    <Form-item label="考试题目：" prop="filePath">
                        <i-input v-model="details.filePath"  :disabled="true"></i-input>
                    </Form-item>

                    <Form-item >
                       <i-table :columns="examinee_columns" :data="examinee_data"></i-table>
                    </Form-item>

                    <Form-item>
                        <div class="cw-btn-group">
                            <!-- 按钮启用/禁用控制（:disabled） -->
                            <i-button type="normal" @click="cancel">取消</i-button>
                        </div>
                    </Form-item>
                </i-form>
            </div>
        </Drawer>

    </div>
</%block>
<script>
     new Vue({
         el: '#app',
         data: function () {
             return {
                 creatEexam:false,
                 detailsData:false,
                 data:[],
                 examinee_data:[],
                 business:[],
                 hosts:[],
                 principal:[],
                 searchInfo: {
                    name: '',
                     site:'',
                    exam_type:'',
                     principal:'',
                    },
                 details:{
                    business:'',
                     name:'',
                     exam_type:'',
                     principal:'',
                     phone:'',
                     exam_date:'',
                     site:'',
                     filePath:'',
                 },
                 formItem:{
                    business:'',
                     name:'',
                     exam_type:'',
                     principal:'',
                     phone:'',
                     exam_date:'',
                     site:'',
                     filePath:'',
                 },
                 exam_type:[
                    {
                       label:'运维开发工程师',
                       value:'运维开发工程师'
                   },
                   {
                       label:'运维自动化工程师',
                       value:'运维自动化工程师'
                   },
                 ],
                 ruleValidate: {
                    business: [
                        { required: true, message: '关联业务不能为空', trigger: 'blur' }
                    ],
                    name: [
                        { required: true, message: '考试名称不能为空', trigger: 'blur' }
                    ],
                    exam_type: [
                        { required: true, message: '考试类型不能为空', trigger: 'blur' }
                    ],
                     principal: [
                        { required: true, message: '负责人不能为空', trigger: 'blur' }
                    ],
                    exam_date: [
                        { required: true, message: '考试时间不能为空', trigger: 'blur' }
                    ],
                     site: [
                        { required: true, message: '考试地址不能为空', trigger: 'blur' }
                    ],
                },
                 examinee_columns:[
                     {
                        title: '考生',
                        key: 'name'
                    },
                     {
                        title: '部门',
                        key: 'department'
                    },
                     {
                        title: '得分',
                        key: 'score'
                    },
                     {
                        title: '结果',
                        key: 'result'
                    },
                     {
                        title: '备注',
                        key: 'desc'
                    },
                 ],
                 columns: [
                    {
                        title: '业务名称',
                        key: 'business'
                    },
                     {
                        title: '考试名称',
                        key: 'name'
                    },
                     {
                        title: '考试类型',
                        key: 'exam_type'
                    },
                     {
                        title: '考试时间',
                        key: 'exam_date'
                    },
                     {
                        title: '考试状态',
                        key: 'exam_state'
                    },
                     {
                        title: '考试地点',
                        key: 'site'
                    },
                    {
                        title: '操作',
                        key: 'actiono',
                        render: (h, params) => {
                            return h('div', [
                                h('Button', {
                                    props: {
                                        type: 'primary',
                                        size: 'small'
                                    },
                                    style: {
                                        marginRight: '5px'
                                    },
                                    on: {
                                        click: () => {
                                            this.show_data(params.row)
                                        }
                                    }
                                }, '详情'),
                            h('Button', {
                                    props: {
                                        type: 'primary',
                                        size: 'error'
                                    },
                                    style: {
                                        marginRight: '5px'
                                    },
                                    on: {
                                        click: () => {
                                            this.delete_data(params.row.id)
                                        }
                                    }
                                }, '删除'),
                            ]);
                        }
                    }
                ],
             }
         },
          methods: {
             //查询业务
             search_biz(){
                axios.get(site_url+ "data_preparation/search_biz/").then(res=>{
                    this.business = res.data.data
                })
            },
              //删除考试
              delete_data(row){
                axios.post(site_url + "data_preparation/delete/"+row).then(
                   res => {
                     this.cancel()
                    if (res.data.result) {
                        this.$Message.success('删除考试成功');
                    } else {
                        this.$Message.error('删除考试失败');
                    }
                    this.search()
               } )
              },
              //根据业务id查询主机
              search_host(row){
                  axios.get(site_url + "data_preparation/search_host/"+ row).then(res=>{
                    this.hosts = res.data.data
                })
              },
              //查询用户
              search_users(){
            axios.get(site_url + 'data_preparation/search_users/').then(res => {
                this.principal = res.data.data
            })
        },
          // 创建考试
            handleCreate() {
                this.$refs['formItem'].validate((valid) => {
                    if (valid) {
                        this.create()
                    } else {
                        this.$Message.error('表单存在未填字段!');
                    }
                })
            },
          create(){
                axios.post(site_url + "data_preparation/add",this.formItem).then(
                   res => {
                     this.cancel()
                    if (res.data.result) {
                        this.$Message.success('添加考试成功');
                    } else {
                        this.$Message.error('添加考试失败');
                    }
                    this.search()
               } )
          },
          //显示详情
          show_data(row){
            this.details = row
            this.detailsData = true
          },
            // 条件查询
            search(){
                axios.get(site_url+ "data_preparation/list",{
                    params: this.searchInfo
                }).then(res=>{
                    this.data = res.data.data
                })
            },
          cancel(){
              this.creatEexam = false
              this.detailsData = false
          },
          handleSuccess(res,file){
                this.formItem.filePath = res.data
            },
            handleError(error,file){
                this.$Message.error("数据导入失败！")
            },
          },
        created() {
            this.search_biz()
            this.search_users()
            this.search()
        }
     })
</script>
<style>
 .flex{
        display: flex;
        flex-wrap: wrap;
    }
    .ivu-form-item{
        flex: 0 0 30%;
    }

    .ivu-date-picker{
        width: 100%;
    }

    .btn{
        margin:0 0 20px 25px;
    }

    .cw-btn-group{
        text-align: center;
    }
</style>